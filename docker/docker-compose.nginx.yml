name: "vanilla"
services:
    nginx:
        build:
            context: "./images/nginx"
        container_name: "nginx"
        ports:
            - "80:80"
            - "8080:8080"
            - "443:443"
        networks:
            vanilla-network:
                aliases: # Allows (sso|dev).vanilla.local to be resolved internally from php-fpm
                    - "sso.vanilla.local"
                    - "dev.vanilla.local"
                    - "e2e-tests.vanilla.local"
                    - "vanilla.test"
                    - "vanilla.local"
                    - "queue.vanilla.local"
                    - "elastic.vanilla.local"
                    - "kibana.vanilla.local"
                    - "search.vanilla.local"
                    - "frontend.vanilla.local"
                    - "files.vanilla.local"
                    - "files-api.vanilla.local"
                    - "management.vanilla.local"
        volumes:
            - "./images/nginx/certs:/usr/local/share/ca-certificates" # Mount self-signed certificates

            # Link our parents so other useful minimal repos like our sso stubs and embed stubs can work.
            # Also needed so relatively symlinked customer repositories work.
            - "../../:/srv/vanilla-repositories"

            # Needed in case our current directory is not named vanilla
            - "../:/srv/vanilla-repositories/vanilla:cached"

            # A few exclusions so that we don't have to sync some large directories.
            - "/srv/vanilla-repositories/vanilla/.git" # Don't sync this one.
            - "/srv/vanilla-repositories/vanilla/node_modules" # Don't sync this one.
            - "/srv/vanilla-repositories/vanilla/.yarn" # Don't sync this one either.

            # Specifically excluded because it runs in its own container.
            - /srv/vanilla-repositories/vanilla-queue-service
            - /srv/vanilla-repositories/vanilla-search-service

            # Mount nginx configs
            - "./images/nginx/sites-enabled:/etc/nginx/sites-enabled"
            - "./images/nginx/nginx.conf:/etc/nginx/nginx.conf"
            - "./images/nginx/partials:/etc/nginx/partials"

            # Sync nginx logs to a volume for usage in the logging container.
            - logs-nginx:/var/log/nginx
        healthcheck:
            test: ["CMD", "curl", "-f", "http://nginx.vanilla.local/health"]
            retries: 3
            timeout: 5s
volumes:
    logs-nginx:

networks:
    vanilla-network:
        external: true
        driver: "bridge"
        name: "vanilla-network"
