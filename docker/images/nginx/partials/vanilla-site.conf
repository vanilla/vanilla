# Default location handling
location / {
    try_files /legacy-dist$uri $uri @vanilla;
}

# Prevent execution or downloading of PHP files
location ~* "\.php(/|$)" {
    try_files . @vanilla;
}

# Vanilla Controller
location @vanilla {
    # send to fastcgi
    include fastcgi_params;

    # relative to the root
    fastcgi_param SCRIPT_NAME /;

    # always execute index.php
    fastcgi_param SCRIPT_FILENAME "$document_root/index.php";

    # pass in the request path, without the query string
    fastcgi_param PATH_INFO $request_path;

    resolver 127.0.0.11 valid=10s;
    set $upstream vanilla-cloud-php:9000; # Must be a variable so nginx doesn't crash.
    fastcgi_pass $upstream;
}
