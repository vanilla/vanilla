<?php
/**
 * @copyright 2009-2023 Vanilla Forums Inc.
 * @license Proprietary
 */

namespace VanillaTests\Sitemaps;

use Vanilla\CurrentTimeStamp;
use VanillaTests\APIv2\AbstractAPIv2Test;
use VanillaTests\Forum\Utils\CommunityApiTestTrait;
use VanillaTests\UsersAndRolesApiTestTrait;

/**
 * Tests of the Sitemap addon class.
 */
class SitemapsTest extends AbstractAPIv2Test
{
    use CommunityApiTestTrait;
    use UsersAndRolesApiTestTrait;

    protected static $addons = ["vanilla", "sitemaps"];

    /**
     * @inheritdoc
     */
    public function setUp(): void
    {
        parent::setUp();
        $config = [
            "Vanilla.Discussions.PerPage" => 2,
        ];
        \Gdn::config()->saveToConfig($config);
        \Gdn::config()->save();
    }

    /**
     * Test index sitemap .
     *
     * @depends testPrepareDataForTest
     * @param array $categories
     * @return void
     */
    public function testSiteMapIndex(array $categories): void
    {
        $result = $this->bessy()->get("sitemapindex.xml")->Data;
        $homepageSitemap = url("sitemap-homepages.xml", true);
        $categorySiteMap = url("sitemap-categories-1-100.xml", true);
        $expectedLoc = [
            $homepageSitemap,
            $categorySiteMap,
            url("sitemap-category-" . $categories["visibleCategoryWithDiscussions"]["urlcode"] . "-1-1000.xml", true),
        ];
        $notExpectedLoc = [
            url("sitemap-category-" . $categories["protectedCategoryWithDiscussion"]["urlcode"] . "-1-1000.xml", true),
        ];

        $sitemapLoc = array_column($result["SiteMaps"], "Loc");

        foreach ($expectedLoc as $loc) {
            $this->assertContains($loc, $sitemapLoc);
        }

        foreach ($notExpectedLoc as $loc) {
            $this->assertNotContains($loc, $sitemapLoc);
        }
    }

    /**
     * Test sitemap homepage
     *
     * @return void
     */
    public function testSiteMapHomePage(): void
    {
        $result = $this->bessy()->get("sitemap-homepages.xml")->Data;

        $homePageURl = \Gdn::request()->getSimpleUrl();

        $this->assertEquals($homePageURl, $result["Urls"][0]["Loc"]);
    }

    /**
     * Test category site map
     *
     * @depends testPrepareDataForTest
     * @param array $categories
     * @return void
     */
    public function testCategorySiteMap(array $categories): void
    {
        $result = $this->bessy()->get("sitemap-categories-1-100.xml")->Data;
        $expectedCategoryUrls = [
            $categories["visibleCategoryWithDiscussions"]["url"],
            $categories["visibleCategoryWithDiscussions"]["url"] . "/p2",
            $categories["visibleCategoryWithDiscussions"]["url"] . "/p3",
        ];
        $this->assertEquals($expectedCategoryUrls, array_column($result["Urls"], "Loc"));
    }

    /**
     * Test single category sitemap.
     *
     * @return void
     */
    public function testSingleCategorySitemap()
    {
        CurrentTimeStamp::mockTime("2023-01-01");
        $category = $this->createCategory(["name" => "Test Category"]);
        $disc1 = $this->createDiscussion(["name" => "Disc 1"]);
        $disc2 = $this->createDiscussion(["name" => "Disc 2"]);
        $result = $this->bessy()->get("/utility/sitemap/category-{$category["urlcode"]}-1-1000.xml")->Data;
        $this->assertEquals([$disc1["url"], $disc2["url"]], array_column($result["Urls"], "Loc"));
    }

    /**
     * Provide necessary data required for test
     *
     * @return array
     */
    public function testPrepareDataForTest(): array
    {
        $this->resetTable("Discussion");
        $this->resetCategoryTable();
        //Create a category with some discussions
        $visibleCategoryWithDiscussions = $this->createCategory([
            "name" => "Category A",
            "description" => "category with discussions",
            "parentCategoryID" => \CategoryModel::ROOT_ID,
        ]);
        $visibleCategoryWithDiscussions["discussions"] = $this->createCategoryDiscussions(
            $visibleCategoryWithDiscussions["categoryID"],
            "Discussion A",
            5
        );
        $visibleCategoryWithNoDiscussion = $this->createCategory([
            "name" => "Category B",
            "description" => "category with no discussions",
            "parentCategoryID" => \CategoryModel::ROOT_ID,
        ]);

        $protectedCategoryWithDiscussion = $this->createPermissionedCategory(
            [
                "name" => "Category C",
                "description" => "category with  discussions having view permission",
                "parentCategoryID" => \CategoryModel::ROOT_ID,
            ],
            [\RoleModel::MEMBER_ID, \RoleModel::ADMIN_ID]
        );
        $protectedCategoryWithDiscussion["discussions"] = $this->createCategoryDiscussions(
            $protectedCategoryWithDiscussion["categoryID"],
            "Discussion C",
            5
        );
        $this->assertTrue(true);
        return [
            "visibleCategoryWithDiscussions" => $visibleCategoryWithDiscussions,
            "visibleCategoryWithNoDiscussion" => $visibleCategoryWithNoDiscussion,
            "protectedCategoryWithDiscussion" => $protectedCategoryWithDiscussion,
        ];
    }

    /**
     * Create Discussion
     *
     * @param int $categoryId
     * @param string $name
     * @param int $counts
     * @return array
     */
    private function createCategoryDiscussions(int $categoryId, string $name = "Test", int $counts = 1)
    {
        $discussions = [];
        for ($i = 0; $i < $counts; $i++) {
            $discussions[] = $this->createDiscussion([
                "name" => $name . "-" . $i,
                "categoryID" => $categoryId,
            ]);
        }
        return $discussions;
    }
}
